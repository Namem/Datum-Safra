<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Datum Safra</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (O CSS continua o mesmo de antes) */
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background-color:#f4f7f6;color:#333;display:flex;flex-direction:column;align-items:center;margin:0;padding:20px}h1{color:#2c3e50}.chart-container{position:relative;width:80vw;max-width:900px;background-color:#fff;border-radius:8px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,.1)}#filters{margin-bottom:20px;padding:10px;background-color:#fff;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1)}select{padding:8px;border-radius:4px;border:1px solid #ddd;margin:0 10px}
    </style>
</head>
<body>
    <h1>Dashboard de Análise: Produção vs. Clima em MT</h1>

    <div id="filters">
        <label for="produto-select">Selecione a Cultura:</label>
        <select name="produto" id="produto-select">
            <option value="soja">Soja</option>
            <option value="milho">Milho</option>
            <option value="algodao">Algodão</option>
            <option value="feijao">Feijão</option>
            <option value="arroz">Arroz</option>
        </select>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('myChart');
            let myChart; // Variável para armazenar a instância do gráfico

            // 2. Função para buscar dados e atualizar o gráfico
            function updateChart(produto = 'soja') {
                // Adiciona um 'loading' visual (opcional)
                console.log(`Buscando dados para: ${produto}`);

                fetch(`/api/chart-data/?produto=${produto}`)
                    .then(response => response.json())
                    .then(data => {
                        if (myChart) {
                            // Se o gráfico já existe, apenas atualiza os dados
                            myChart.data = data;
                            myChart.update();
                        } else {
                            // Se é a primeira vez, cria o gráfico
                            myChart = new Chart(ctx, {
                                type: 'bar',
                                data: data,
                                options: { /* (Opções do gráfico - iguais às de antes) */
                                    responsive:true,interaction:{mode:'index',intersect:false},scales:{x:{stacked:false},'y-producao':{type:'linear',position:'left',title:{display:true,text:'Produção (Toneladas)'}},'y-precipitacao':{type:'linear',position:'right',title:{display:true,text:'Precipitação Total Anual (mm)'},grid:{drawOnChartArea:false}}}
                                }
                            });
                        }
                    })
                    .catch(error => console.error('Erro ao buscar dados para o gráfico:', error));
            }

            // 3. Adiciona o 'escutador' de eventos para o filtro
            const produtoSelect = document.getElementById('produto-select');
            produtoSelect.addEventListener('change', (event) => {
                updateChart(event.target.value);
            });

            // 4. Carrega o gráfico inicial (com Soja)
            updateChart(); 
        });
    </script>
</body>
</html>